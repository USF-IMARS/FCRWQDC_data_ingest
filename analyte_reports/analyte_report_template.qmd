---
title: "Ammonia (N) Report"
author: "Tylar Murray"
format: html
params:
  analyte: "Ammonia (N)"  # must be Ammonia (N) before rendering
---

```{R, get data across all programs}
#| code-summary: get data across all programs
#| message: false
#| warning: false
library('here')
source(here("R/getAllData.R"))
df <- getAllData()
```

```{R, create table of stations}
station_df <- df %>%
  select(program, Monitoring.Location.ID) %>%
  distinct()
```

```{R, create station statistics dataframe}
source(here("R/seasonalMannKendall.R"))
# create table of samples for each station
samples_df <- df %>%
  select(
    program, Monitoring.Location.ID, Activity.Start.Date.Time,
    DEP.Result.Value.Number, DEP.Result.Unit
    ) %>%
  distinct()

# add statistics for each station
sample_stats_df <- samples_df %>%
  group_by(program, Monitoring.Location.ID) %>%
  summarise(
    n_values = n(),
    mean_value = round(mean(DEP.Result.Value.Number, na.rm = TRUE), 2),
    # mannKendall
    trend = seasonalMannKendall(
      Monitoring.Location.ID,  
      Activity.Start.Date.Time,
      DEP.Result.Value.Number  
    ),
    # more...
    .groups = "drop"
  )

library(skimr)
skim(sample_stats_df)
print(head(sample_stats_df))
```

```{R, create table of statistics for selected analyte}
#| code-summary: create table of statistics for selected analyte
#| message: true
#| warning: true
source(here("R/seasonalMannKendall.R"))
library(dplyr)
library(lubridate)

# Print which analyte we're analyzing
cat(paste0("Analyzing data for analyte: ", params$analyte, "\n"))

# Filter data to only include the selected analyte
analyte_df <- df %>%
  filter(DEP.Analyte.Name == params$analyte)

# Create a unique identifier by combining program and station ID
analyte_df$id <- paste0(analyte_df$program, "_", analyte_df$Monitoring.Location.ID)

# Count how many stations have data for this analyte
station_count <- length(unique(analyte_df$id))
cat(paste0("Found ", station_count, " stations with data for ", params$analyte, "\n"))

# Create a clean analyte data table
mean_table <- analyte_df %>%
  # Select only the relevant columns
  select(id, program, Monitoring.Location.ID, DEP.Result.Value.Number, DEP.Result.Unit) %>%
  # Remove rows with missing result values
  filter(!is.na(DEP.Result.Value.Number)) %>%
  # Convert to numeric to ensure proper calculation
  mutate(DEP.Result.Value.Number = as.numeric(DEP.Result.Value.Number)) %>%
  # Group by location
  group_by(id, program, Monitoring.Location.ID, DEP.Result.Unit) %>%
  # Calculate mean for each group
  summarise(
    n_values = n(),
    mean_value = round(mean(DEP.Result.Value.Number, na.rm = TRUE), 2),
    .groups = "drop"
  ) %>%
  # Create a formatted string with the mean and unit
  mutate(formatted_result = paste0(mean_value, " ", DEP.Result.Unit))

# Display summary statistics
cat(paste0("Total observations for ", params$analyte, ": ", sum(mean_table$n_values), "\n"))

# Run Seasonal Mann-Kendall trend analysis
cat("\n### Performing Seasonal Mann-Kendall Trend Analysis\n")
mkr <- seasonalMannKendall(analyte_df)

# Convert the result matrix to a dataframe with proper types
mkr_df <- as.data.frame(mkr, stringsAsFactors = FALSE)
mkr_df$Monitoring.Location.ID <- as.character(mkr_df$Monitoring.Location.ID)
# Force conversion to numeric by first converting to character
mkr_df$Trend.Slope <- suppressWarnings(as.numeric(as.character(mkr_df$Trend.Slope)))

# Create a mapping from id to Monitoring.Location.ID
id_mapping <- analyte_df %>%
  select(id, Monitoring.Location.ID) %>%
  distinct()

# Join trend results with the id mapping
mkr_with_ids <- mkr_df %>%
  left_join(id_mapping, by = "Monitoring.Location.ID")

# Now join with the mean table
mean_table_with_trends <- mean_table %>%
  left_join(mkr_with_ids, by = c("id", "Monitoring.Location.ID"))

# Add the trend direction based on slope
mean_table_with_trends <- mean_table_with_trends %>%
    mutate(
      Trend.Slope = case_when(
        is.na(Trend.Slope) ~ NA_real_,
        !is.numeric(Trend.Slope) ~ NA_real_,
        TRUE ~ round(as.numeric(Trend.Slope), 4)
      ),
      Trend.Direction = case_when(
        is.na(Trend.Slope) ~ "??",
        Trend.Slope > 0 ~ "_/",
        Trend.Slope < 0 ~ "\_",
        TRUE ~ "--"
      )
    )



# Sort by mean value (descending) to see highest concentrations first
sorted_mean_table <- mean_table_with_trends %>%
  arrange(desc(mean_value))

# Display the table with program name for context
result_table <- sorted_mean_table %>%
  select(program, Monitoring.Location.ID, n_values, mean_value, DEP.Result.Unit, Trend.Slope, Trend.Direction)

# Add a title to the table
cat(paste0("\n## Mean ", params$analyte, " Concentrations and Trends by Station\n"))
cat("*Note: Trend slope represents the estimated change per month from the Seasonal Mann-Kendall test*\n")

# Display the table using pander for better formatting
library(pander)

# Print the structure of the table to help with debugging
str(result_table)

# Create a safer digits vector by checking the column types
digits_vector <- sapply(names(result_table), function(col_name) {
  x <- result_table[[col_name]]
  if(is.numeric(x)) {
    # For numeric columns, use appropriate precision
    if(col_name == "mean_value") {
      return(2)  # 2 decimal places for mean values
    } else if(col_name == "Trend.Slope") {
      return(4)  # 4 decimal places for trend slopes
    } else if(col_name == "n_values") {
      return(0)  # 0 decimal places for count values
    } else {
      return(2)  # 2 decimal places for other numeric columns
    }
  } else {
    # For non-numeric columns, use NA
    return(NA)
  }
})

# Display the table with appropriate formatting
tryCatch({
  # Add column names to the digits vector
  names(digits_vector) <- names(result_table)
  # Print the digits vector for debugging
  print(digits_vector)
  # Use pander with the named digits vector
  pander(result_table, digits = digits_vector)
}, error = function(e) {
  # Fallback to simpler formatting if the digits specification fails
  cat(paste("Error in pander with digits specification:", e$message, "\n"))
  cat("Falling back to simpler formatting...\n")
  # Try a simpler approach with column-specific formatting
  result_table$mean_value <- round(result_table$mean_value, 2)
  if("Trend.Slope" %in% names(result_table)) {
    # Only round numeric values
    result_table$Trend.Slope <- sapply(result_table$Trend.Slope, function(x) {
      if(is.numeric(x) && !is.na(x)) return(round(x, 4)) else return(x)
    })
  }
  pander(result_table)
})

```

```{R, create histogram of means}

# Create a simple histogram of the values
if (nrow(mean_table) > 0) {
  cat(paste0("\n## Distribution of ", params$analyte, " Concentrations\n"))
  hist(mean_table$mean_value, 
       main = paste0("Histogram of Mean ", params$analyte, " Values"),
       xlab = paste0(params$analyte, " (", unique(mean_table$DEP.Result.Unit)[1], ")"),
       col = "lightblue",
       breaks = min(20, max(5, nrow(mean_table) %/% 5)))
}
```